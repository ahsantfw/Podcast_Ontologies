{% extends "base.html" %}

{% block title %}Query - Knowledge Graph System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-chat-dots"></i> Query Knowledge Graph</h1>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-question-circle"></i> Ask a Question</h5>
            </div>
            <div class="card-body">
                <form id="query-form" onsubmit="submitQuery(event)">
                    <div class="mb-3">
                        <label for="question-input" class="form-label">Your Question:</label>
                        <textarea 
                            class="form-control" 
                            id="question-input" 
                            rows="4" 
                            placeholder="e.g., What practices are most associated with improving clarity?"
                            required
                        ></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="bi bi-search"></i> Query
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearQuery()">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </form>
            </div>
        </div>

        <!-- Answer Display -->
        <div class="card mt-4" id="answer-card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-lightbulb"></i> Answer</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleSources()" id="toggle-sources-btn">
                        <i class="bi bi-file-text"></i> Show Sources
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="toggleGraph()" id="toggle-graph-btn">
                        <i class="bi bi-diagram-2"></i> Show Graph
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="answer-content">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- Metadata -->
                <div id="answer-metadata" class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <span id="method-badge"></span>
                        <span id="rag-kg-breakdown"></span>
                    </small>
                </div>

                <!-- Sources (Hidden by default) -->
                <div id="sources-container" style="display: none;" class="mt-4 pt-3 border-top">
                    <h6><i class="bi bi-file-text"></i> Sources:</h6>
                    <ul id="sources-list" class="list-group list-group-flush"></ul>
                </div>

                <!-- Graph Visualization (Hidden by default) -->
                <div id="graph-container" style="display: none;" class="mt-4 pt-3 border-top">
                    <h6><i class="bi bi-diagram-2"></i> Graph Visualization:</h6>
                    <div id="graph-visualization" class="border rounded p-3" style="min-height: 300px;">
                        <p class="text-muted text-center">Graph visualization will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Conversation History -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-clock-history"></i> Conversation</h5>
                <button class="btn btn-sm btn-outline-danger" onclick="clearSession()">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="conversation-history">
                    <p class="text-muted">No conversation yet</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let sessionId = null;
    let currentAnswer = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Load session if exists
        sessionId = localStorage.getItem('session_id');
        if (sessionId) {
            loadConversationHistory();
        }
    });

    function submitQuery(event) {
        event.preventDefault();
        
        const question = document.getElementById('question-input').value.trim();
        if (!question) return;

        const workspaceId = getWorkspaceId();
        const submitBtn = document.getElementById('submit-btn');
        const answerCard = document.getElementById('answer-card');
        const answerContent = document.getElementById('answer-content');

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Querying...';
        answerCard.style.display = 'block';
        answerContent.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';

        // Add question to conversation
        addToConversation('user', question);

        // Submit query
        fetch('/api/v1/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Workspace-Id': workspaceId
            },
            body: JSON.stringify({
                question: question,
                session_id: sessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            currentAnswer = data;
            sessionId = data.session_id;
            localStorage.setItem('session_id', sessionId);

            // Display answer
            answerContent.innerHTML = `<div class="answer-text">${formatAnswer(data.answer)}</div>`;

            // Display metadata
            const metadata = data.metadata || {};
            const method = metadata.method || 'hybrid';
            const methodBadge = `<span class="badge bg-${method === 'hybrid' ? 'primary' : method === 'rag' ? 'success' : 'info'}">${method.toUpperCase()}</span>`;
            
            let breakdown = '';
            if (metadata.rag_count !== undefined && metadata.kg_count !== undefined) {
                breakdown = ` | RAG: ${metadata.rag_count}, KG: ${metadata.kg_count}`;
            }
            
            document.getElementById('method-badge').innerHTML = methodBadge;
            document.getElementById('rag-kg-breakdown').textContent = breakdown;

            // Display sources
            if (data.sources && data.sources.length > 0) {
                displaySources(data.sources);
            }

            // Add answer to conversation
            addToConversation('assistant', data.answer);

            // Reset form
            document.getElementById('question-input').value = '';
        })
        .catch(error => {
            answerContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-search"></i> Query';
        });
    }

    function formatAnswer(answer) {
        // Simple formatting - split by paragraphs
        return answer.split('\n').map(para => {
            if (para.trim().startsWith('#')) {
                return `<h6>${para.replace(/^#+\s*/, '')}</h6>`;
            }
            return `<p>${para.trim()}</p>`;
        }).join('');
    }

    function displaySources(sources) {
        const sourcesList = document.getElementById('sources-list');
        sourcesList.innerHTML = sources.slice(0, 10).map((source, idx) => {
            const episodeId = source.episode_id || 'Unknown';
            const timestamp = source.timestamp || '';
            const speaker = source.speaker || '';
            return `
                <li class="list-group-item">
                    <strong>${idx + 1}.</strong> ${episodeId}
                    ${timestamp ? ` <span class="text-muted">(${timestamp})</span>` : ''}
                    ${speaker ? ` <span class="text-muted">- ${speaker}</span>` : ''}
                    <br><small class="text-muted">${(source.text || '').substring(0, 150)}...</small>
                </li>
            `;
        }).join('');
    }

    function toggleSources() {
        const container = document.getElementById('sources-container');
        const btn = document.getElementById('toggle-sources-btn');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide Sources';
            if (currentAnswer && currentAnswer.sources) {
                displaySources(currentAnswer.sources);
            }
        } else {
            container.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-file-text"></i> Show Sources';
        }
    }

    function toggleGraph() {
        const container = document.getElementById('graph-container');
        const btn = document.getElementById('toggle-graph-btn');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide Graph';
            // TODO: Implement graph visualization
            document.getElementById('graph-visualization').innerHTML = 
                '<p class="text-muted">Graph visualization coming soon</p>';
        } else {
            container.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-diagram-2"></i> Show Graph';
        }
    }

    function addToConversation(role, content) {
        const history = document.getElementById('conversation-history');
        if (history.innerHTML.includes('No conversation yet')) {
            history.innerHTML = '';
        }

        const roleClass = role === 'user' ? 'text-end' : 'text-start';
        const roleIcon = role === 'user' ? 'bi-person' : 'bi-robot';
        const roleBadge = role === 'user' ? 'bg-primary' : 'bg-secondary';

        history.innerHTML += `
            <div class="mb-2 ${roleClass}">
                <span class="badge ${roleBadge} mb-1">
                    <i class="bi ${roleIcon}"></i> ${role === 'user' ? 'You' : 'Assistant'}
                </span>
                <div class="border rounded p-2 ${role === 'user' ? 'bg-light' : ''}">
                    ${content.substring(0, 200)}${content.length > 200 ? '...' : ''}
                </div>
            </div>
        `;

        // Scroll to bottom
        history.scrollTop = history.scrollHeight;
    }

    function loadConversationHistory() {
        if (!sessionId) return;
        // TODO: Load from API
    }

    function clearSession() {
        sessionId = null;
        localStorage.removeItem('session_id');
        document.getElementById('conversation-history').innerHTML = '<p class="text-muted">No conversation yet</p>';
    }

    function clearQuery() {
        document.getElementById('question-input').value = '';
        document.getElementById('answer-card').style.display = 'none';
    }
</script>
{% endblock %}

