{% extends "base.html" %}

{% block title %}Generate Script - Knowledge Graph System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-file-text"></i> Generate Script</h1>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-sliders"></i> Script Parameters</h5>
            </div>
            <div class="card-body">
                <form id="script-form" onsubmit="generateScript(event)">
                    <div class="mb-3">
                        <label for="theme-input" class="form-label">Theme/Topic:</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="theme-input" 
                            placeholder="e.g., creativity, discipline, clarity"
                            required
                        >
                        <div class="form-text">The main theme or topic for the script</div>
                    </div>

                    <div class="mb-3">
                        <label for="runtime-input" class="form-label">Runtime (minutes):</label>
                        <input 
                            type="range" 
                            class="form-range" 
                            id="runtime-input" 
                            min="15" 
                            max="60" 
                            value="45"
                            oninput="updateRuntimeDisplay(this.value)"
                        >
                        <div class="text-center">
                            <span id="runtime-display">45</span> minutes
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="style-select" class="form-label">Style:</label>
                        <select class="form-select" id="style-select">
                            <option value="tapestry">Tapestry (interweaving)</option>
                            <option value="thematic">Thematic (by theme)</option>
                            <option value="linear">Linear (chronological)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="max-quotes-input" class="form-label">Max Quotes:</label>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="max-quotes-input" 
                            min="5" 
                            max="50" 
                            value="20"
                        >
                    </div>

                    <div class="mb-3">
                        <label for="format-select" class="form-label">Output Format:</label>
                        <select class="form-select" id="format-select">
                            <option value="markdown">Markdown</option>
                            <option value="json">JSON</option>
                            <option value="plain">Plain Text</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="generate-btn">
                        <i class="bi bi-magic"></i> Generate Script
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- Script Preview -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-eye"></i> Script Preview</h5>
                <button class="btn btn-sm btn-success" id="download-btn" style="display: none;" onclick="downloadScript()">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
            <div class="card-body">
                <div id="script-preview">
                    <p class="text-muted text-center">Script will appear here after generation</p>
                </div>
            </div>
        </div>

        <!-- Metadata -->
        <div class="card mt-3" id="metadata-card" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Metadata</h5>
            </div>
            <div class="card-body" id="metadata-content">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentScript = null;

    function updateRuntimeDisplay(value) {
        document.getElementById('runtime-display').textContent = value;
    }

    function generateScript(event) {
        event.preventDefault();

        const workspaceId = getWorkspaceId();
        const generateBtn = document.getElementById('generate-btn');
        const preview = document.getElementById('script-preview');
        const metadataCard = document.getElementById('metadata-card');

        // Show loading
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
        preview.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Generating script...</p></div>';

        const requestData = {
            theme: document.getElementById('theme-input').value,
            runtime_minutes: parseInt(document.getElementById('runtime-input').value),
            style: document.getElementById('style-select').value,
            max_quotes: parseInt(document.getElementById('max-quotes-input').value),
            format: document.getElementById('format-select').value
        };

        fetch('/api/v1/scripts/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Workspace-Id': workspaceId
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            currentScript = data;
            
            // Display script
            if (data.formatted) {
                preview.innerHTML = `<pre class="border rounded p-3 bg-light" style="max-height: 500px; overflow-y: auto;">${escapeHtml(data.formatted)}</pre>`;
            } else {
                preview.innerHTML = '<p class="text-danger">No script content returned</p>';
            }

            // Display metadata
            if (data.metadata) {
                metadataCard.style.display = 'block';
                const meta = data.metadata;
                document.getElementById('metadata-content').innerHTML = `
                    <p><strong>Theme:</strong> ${meta.theme || 'N/A'}</p>
                    <p><strong>Runtime:</strong> ${meta.runtime_minutes || 'N/A'} minutes</p>
                    <p><strong>Style:</strong> ${meta.style || 'N/A'}</p>
                    <p><strong>Total Quotes:</strong> ${meta.total_quotes || 0}</p>
                    <p><strong>Total Segments:</strong> ${meta.total_segments || 0}</p>
                    ${meta.episodes ? `<p><strong>Episodes:</strong> ${meta.episodes.join(', ')}</p>` : ''}
                `;
            }

            // Show download button
            document.getElementById('download-btn').style.display = 'block';
        })
        .catch(error => {
            preview.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        })
        .finally(() => {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Script';
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function downloadScript() {
        if (!currentScript || !currentScript.formatted) {
            alert('No script to download');
            return;
        }

        const blob = new Blob([currentScript.formatted], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentScript.title || 'script'}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}

